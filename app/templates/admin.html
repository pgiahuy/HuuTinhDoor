<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head>

<body>
    <header>
        <h1>Admin Dashboard</h1>
        <div class="header-actions">
            <a href="{{ url_for('admin.logout') }}" class="btn-logout">Đăng xuất</a>
        </div>
    </header>

    <nav class="navbar">
        <button id="toggleFormProductBtn" class="btn-toggle-form">Thêm sản phẩm</button>
        <button id="toggleFormProjectBtn" class="btn-toggle-form">Thêm công trình</button>
    </nav>

    <main class="container">

        <!-- FORM THÊM SẢN PHẨM -->
        <section class="form-container" id="addProductForm" style="display:none;">
            <button type="button" id="CloseProductFormBtn" class="btn-close">✖</button>
            <h2>Thêm sản phẩm</h2>
            <form method="POST" enctype="multipart/form-data" action="{{ url_for('admin.add_product') }}">
                <label>Tên sản phẩm:</label>
                <input type="text" name="name" required>

                <label>Giá:</label>
                <input type="number" step="0.01" name="price" required>

                <label>Danh mục:</label>
                <select name="category_id" id="categorySelect" required>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>

                <label>Loại sản phẩm:</label>
                <select name="subcategory_id" id="subcategorySelect" required>
                    {% for sub in subcategories %}
                    <option value="{{ sub.id }}" data-category="{{ sub.category_id }}">{{ sub.name }}</option>
                    {% endfor %}
                </select>

                <label>Mô tả:</label>
                <textarea name="description" rows="3"></textarea>

                <label>Ảnh sản phẩm:</label>
                <input type="file" name="images" multiple id="imagesProductInput">

                <div id="previewProductContainer" class="preview-container"></div>

                <input type="hidden" name="main_image_index" id="main_image_product_index">
                <input type="submit" value="Thêm sản phẩm" class="btn-submit">
            </form>
        </section>


        <!-- FORM THÊM CÔNG TRÌNH -->
        <section class="form-container" id="addProjectForm" style="display:none;">
            <button type="button" id="closeProjectFormBtn" class="btn-close">✖</button>
            <h2>Thêm công trình</h2>
            <form method="POST" enctype="multipart/form-data" action="{{ url_for('admin.add_project') }}">
                <label>Tên công trình:</label>
                <input type="text" name="name" required>

                <label>Mô tả:</label>
                <textarea name="description" rows="3"></textarea>

                <label>Ảnh công trình:</label>
                <input type="file" name="images" multiple id="imagesProjectInput">

                <div id="previewProjectContainer" class="preview-container"></div>

                <input type="hidden" name="main_image_index" id="main_image_project_index">
                <input type="submit" value="Thêm công trình" class="btn-submit">
            </form>
        </section>


        <!-- DANH SÁCH SẢN PHẨM -->
        <section class="list-container">
            <h2>Danh sách sản phẩm</h2>
            <div class="product-list">
                {% for p in products %}
                <div class="product-card">
                    {% set main_image = p.images|selectattr("is_main")|first %}
                    {% if main_image %}
                    <img src="{{ main_image.url }}" alt="{{ p.name }}">
                    {% endif %}
                    <h3>{{ p.name }}</h3>
                    <p>Giá: ${{ p.price }}</p>
                    <p>Category: {{ p.category_id }}</p>
                    <div>
                        <a href="{{ url_for('admin.edit_product', product_id=p.id) }}" class="btn-edit">Sửa</a>
                        <a href="{{ url_for('admin.delete_product', product_id=p.id) }}" class="btn-delete"
                            onclick="return confirm('Bạn có chắc chắn muốn xóa sản phẩm này?');">Xóa</a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            /* ----------------- Lọc subcategory ----------------- */
            const categorySelect = document.getElementById('categorySelect');
            const subcategorySelect = document.getElementById('subcategorySelect');

            function filterSubcategories() {
                const selectedCategory = categorySelect.value;
                let firstVisible = null;

                Array.from(subcategorySelect.options).forEach(option => {
                    if (option.dataset.category === selectedCategory) {
                        option.style.display = 'block';
                        if (!firstVisible) firstVisible = option;
                    } else {
                        option.style.display = 'none';
                    }
                });

                subcategorySelect.value = firstVisible ? firstVisible.value : "";
            }

            filterSubcategories();
            categorySelect.addEventListener('change', filterSubcategories);

            /* ----------------- Toggle Form Sản phẩm ----------------- */
            const toggleFormProductBtn = document.getElementById('toggleFormProductBtn');
            const addProductForm = document.getElementById('addProductForm');
            const closeProductFormBtn = document.getElementById('CloseProductFormBtn');

            toggleFormProductBtn.addEventListener('click', () => {
                addProjectForm.style.display = 'none';
                addProductForm.style.display = 'block';
                // window.scrollTo({ top: addProductForm.offsetTop -50, behavior: 'smooth' });
            });

            closeProductFormBtn.addEventListener('click', () => {
                addProductForm.style.display = 'none';
            });

            /* ----------------- Toggle Form Công trình ----------------- */
            const toggleFormProjectBtn = document.getElementById('toggleFormProjectBtn');
            const addProjectForm = document.getElementById('addProjectForm');
            const closeProjectFormBtn = document.getElementById('closeProjectFormBtn');

            toggleFormProjectBtn.addEventListener('click', () => {
                addProductForm.style.display = 'none';
                addProjectForm.style.display = 'block';
                // window.scrollTo({ top: addProjectForm.offsetTop-50, behavior: 'smooth' });
            });

            closeProjectFormBtn.addEventListener('click', () => {
                addProjectForm.style.display = 'none';

            });

            /* ----------------- Preview Ảnh Sản phẩm ----------------- */
            const productInput = document.getElementById('imagesProductInput');
            const productPreview = document.getElementById('previewProductContainer');
            const productMainIndex = document.getElementById('main_image_product_index');

            productInput.addEventListener('change', () => {
                productPreview.innerHTML = '';
                const files = productInput.files;
                for (let i = 0; i < files.length; i++) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const div = document.createElement('div');
                        div.classList.add('preview-item');

                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.classList.add('preview-img');
                        div.appendChild(img);

                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = 'main_image_product';
                        radio.value = i;
                        radio.classList.add('radio-main');
                        if (i === 0) radio.checked = true;

                        radio.addEventListener('change', () => {
                            productMainIndex.value = i;
                        });

                        div.appendChild(radio);
                        productPreview.appendChild(div);
                        productMainIndex.value = 0;
                    };
                    reader.readAsDataURL(files[i]);
                }
            });

            /* ----------------- Preview Ảnh Công trình ----------------- */
            const projectInput = document.getElementById('imagesProjectInput');
            const projectPreview = document.getElementById('previewProjectContainer');
            const projectMainIndex = document.getElementById('main_image_project_index');

            projectInput.addEventListener('change', () => {
                projectPreview.innerHTML = '';
                const files = projectInput.files;
                for (let i = 0; i < files.length; i++) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const div = document.createElement('div');
                        div.classList.add('preview-item');

                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.classList.add('preview-img');
                        div.appendChild(img);

                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = 'main_image_project';
                        radio.value = i;
                        radio.classList.add('radio-main');
                        if (i === 0) radio.checked = true;

                        radio.addEventListener('change', () => {
                            projectMainIndex.value = i;
                        });

                        div.appendChild(radio);
                        projectPreview.appendChild(div);
                        projectMainIndex.value = 0;
                    };
                    reader.readAsDataURL(files[i]);
                }
            });
        });
    </script>
</body>

</html>
